name: PNW-MVP Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v3

      - name: 🔍 Ensure Correct Directory Structure
        run: chmod +x setup_pnw_directory.sh && ./setup_pnw_directory.sh

      - name: 🔑 Set Aleo Private Key from Repository Secret
        run: echo "ALEO_PRIVATE_KEY=${{ secrets.ALEO_PRIVATE_KEY }}" >> $GITHUB_ENV

      - name: 🔧 Set Up Environment Variables
        run: |
          export PATH=pnw_mvp/Directory/.aleo:$PATH
          echo "export PATH=pnw_mvp/Directory/.aleo:\$PATH" >> $GITHUB_ENV
          echo "🔑 Aleo Private Key Set Successfully (Hidden for Security)"

      - name: 🔥 Install Leo CLI (Correct Directory)
        run: |
          echo "⬇️ Downloading and Installing Leo CLI..."
          curl -L -o leo.zip https://github.com/ProvableHQ/leo/releases/download/v2.4.1/leo-mainnet-x86_64-unknown-linux-gnu.zip
          unzip leo.zip -d pnw_mvp/Directory/leo_install  # ✅ Extract Leo into the correct directory
          mkdir -p pnw_mvp/Directory/.aleo  # ✅ Ensure .aleo directory exists in the right location
          mv pnw_mvp/Directory/leo_install/leo pnw_mvp/Directory/.aleo/  # ✅ Move Leo to the correct path
          chmod +x pnw_mvp/Directory/.aleo/leo
          echo "✅ Leo CLI Installed Successfully!"

      - name: 🚀 Deploy PNW-MVP Contracts with Verbose Logging
        run: |
          chmod +x deploy_pnw_mvp.sh
          echo "🛠️ Running Deployment with Verbose Logging..."
          pnw_mvp/Directory/.aleo/leo deploy --verbose 2>&1 | tee deploy_log.txt

      - name: 📜 Upload Deployment Logs (For Debugging)
        uses: actions/upload-artifact@v4  # Updated to v4 for stability
        with:
          name: deploy_logs
          path: deploy_log.txt

      - name: ✅ Deployment Complete
        run: echo "🚀 All contracts successfully deployed!"
