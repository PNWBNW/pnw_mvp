name: Deploy PNW-MVP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up Aleo CLI
        run: |
          export PATH=$HOME/.aleo:$PATH
          curl -L -o leo.tar.gz https://github.com/ProvableHQ/leo/releases/download/v2.4.1/leo-mainnet-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf leo.tar.gz
          mv leo $HOME/.aleo/
          chmod +x $HOME/.aleo/leo
          echo "export PATH=$HOME/.aleo:\$PATH" >> $GITHUB_ENV
          echo "$HOME/.aleo" >> $GITHUB_PATH

      - name: Build & Deploy Contracts
        run: |
          export PATH=$HOME/.aleo:$PATH
          echo "ðŸ”¥ Deploying Contracts in Optimized Order..."
          
          # Deployment order (ensuring dependencies exist first)
          for contract in \
            "src/credits" \
            "src/employer_agreement" \
            "src/process_tax_compliance" \
            "src/subdao_reserve" \
            "src/oversightdao_reserve" \
            "src/pncw_payroll" \
            "src/pniw_payroll" \
            "src/weekly_payroll_pool"
          do
            echo "ðŸš€ Deploying $contract"
            leo deploy --network testnet --path $contract --private-key ${ALEO_PRIVATE_KEY}
          done
