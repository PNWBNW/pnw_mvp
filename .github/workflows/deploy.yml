name: Deploy PNW-MVP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up Aleo CLI
        run: |
          export PATH=$HOME/.aleo:$PATH
          echo "ðŸ”¥ Downloading and Installing Leo CLI..."
          
          # Download the correct Leo version (ZIP format)
          curl -L -o leo.zip https://github.com/ProvableHQ/leo/releases/download/v2.4.1/leo-mainnet-x86_64-unknown-linux-gnu.zip
          
          # Extract the binary
          unzip leo.zip -d leo_install
          
          # Move binary to Aleo path
          mv leo_install/leo $HOME/.aleo/
          chmod +x $HOME/.aleo/leo
          
          # Add Leo CLI to system PATH
          echo "export PATH=$HOME/.aleo:\$PATH" >> $GITHUB_ENV
          echo "$HOME/.aleo" >> $GITHUB_PATH

      - name: Verify Leo Installation
        run: |
          export PATH=$HOME/.aleo:$PATH
          echo "âœ… Checking Leo Version..."
          leo --version

      - name: Build & Deploy Contracts
        run: |
          export PATH=$HOME/.aleo:$PATH
          echo "ðŸ”¥ Deploying Contracts in Optimized Order..."
          
          # Deployment order (ensuring dependencies exist first)
          for contract in \
            "src/credits" \
            "src/employer_agreement" \
            "src/process_tax_compliance" \
            "src/subdao_reserve" \
            "src/oversightdao_reserve" \
            "src/pncw_payroll" \
            "src/pniw_payroll" \
            "src/weekly_payroll_pool"
          do
            echo "ðŸš€ Deploying $contract"
            leo deploy --network testnet --path $contract --private-key ${ALEO_PRIVATE_KEY}
          done
